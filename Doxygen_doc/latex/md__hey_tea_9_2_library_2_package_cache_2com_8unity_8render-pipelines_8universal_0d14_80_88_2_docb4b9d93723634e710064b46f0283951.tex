\chapter{How to create a custom Renderer Feature}
\hypertarget{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951}{}\label{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951}\index{How to create a custom Renderer Feature@{How to create a custom Renderer Feature}}
\label{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2397}%
\Hypertarget{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2397}%
 This section describes how to create a custom Renderer Feature for a URP Renderer.

This section assumes the following\+:


\begin{DoxyItemize}
\item The {\bfseries{Scriptable Render Pipeline Settings}} property refers to a URP asset ({\bfseries{Project Settings}} \texorpdfstring{$>$}{>} {\bfseries{\doxylink{namespace_graphics}{Graphics}}} \texorpdfstring{$>$}{>} {\bfseries{Scriptable Render Pipeline Settings}}).
\end{DoxyItemize}

This article contains the following sections\+:


\begin{DoxyItemize}
\item Create example Scene and Game\+Objects.
\item Create a scriptable Renderer Feature and add it to the Universal Renderer.
\item Create and enqueue the scriptable Render Pass.
\item Implement rendering commands in the Execute method.
\item Implement the example-\/specific Material and rendering code.
\item Change the order of the render passes
\item Complete code for this example
\end{DoxyItemize}\hypertarget{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2398}{}\doxysection{\texorpdfstring{\label{_example-scene}%
Create example Scene and Game\+Objects}{\label{_example-scene}%
Create example Scene and Game\+Objects}}\label{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2398}
To follow the steps in this section, create a new Scene with the following Game\+Objects\+:


\begin{DoxyEnumerate}
\item Create a plane.
\item Create a new Material and assign it the {\ttfamily Universal Render Pipeline/\+Lit} shader. Set the base color to grey (for example, {\ttfamily \#6A6\+A6A}). Call the Material {\ttfamily Plane}.
\item Create a Point Light and place it above the plane.
\end{DoxyEnumerate}

Your Scene should look like the following illustration\+:

\hypertarget{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2399}{}\doxysection{\texorpdfstring{\label{_scriptable-renderer-feature}%
Create a scriptable Renderer Feature and add it to the Universal Renderer}{\label{_scriptable-renderer-feature}%
Create a scriptable Renderer Feature and add it to the Universal Renderer}}\label{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2399}
This part shows how to create a scriptable Renderer Feature and implement the methods that let you configure and inject {\ttfamily Scriptable\+Render\+Pass} instances into the scriptable Renderer.


\begin{DoxyEnumerate}
\item Create a new C\# script. Call the script {\ttfamily Lens\+Flare\+Renderer\+Feature.\+cs}.
\item Open the script, remove all the code from the {\ttfamily Lens\+Flare\+Renderer\+Feature} class that \doxylink{namespace_unity}{Unity} created. Add the following {\ttfamily using} directive.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ \textcolor{keyword}{using\ }UnityEngine.Rendering.Universal;}

\end{DoxyCode}

\item The {\ttfamily Lens\+Flare\+Renderer\+Feature} class must inherit from the {\ttfamily Scriptable\+Renderer\+Feature} class.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ \textcolor{keyword}{public}\ \textcolor{keyword}{class\ }LensFlareRendererFeature\ :\ \mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_renderer_feature}{ScriptableRendererFeature}}}

\end{DoxyCode}

\item The class must implement the following methods\+:
\begin{DoxyItemize}
\item {\ttfamily Create}\+: \doxylink{namespace_unity}{Unity} calls this method on the following events\+:
\begin{DoxyItemize}
\item When the Renderer Feature loads the first time.
\item When you enable or disable the Renderer Feature.
\item When you change a property in the inspector of the Renderer Feature.
\end{DoxyItemize}
\item {\ttfamily Add\+Render\+Passes}\+: \doxylink{namespace_unity}{Unity} calls this method every frame, once for each Camera. This method lets you inject {\ttfamily Scriptable\+Render\+Pass} instances into the scriptable Renderer.
\end{DoxyItemize}
\end{DoxyEnumerate}

Now you have the custom {\ttfamily Lens\+Flare\+Renderer\+Feature} Renderer Feature with its main methods.

Below is the complete code for this part.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\ \#}}
\DoxyCodeLine{\textcolor{keyword}{using\ }\mbox{\hyperlink{namespace_unity_engine}{UnityEngine}};}
\DoxyCodeLine{\textcolor{keyword}{using\ }UnityEngine.Rendering;}
\DoxyCodeLine{\textcolor{keyword}{using\ }UnityEngine.Rendering.Universal;}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{public}\ \textcolor{keyword}{class\ }LensFlareRendererFeature\ :\ \mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_renderer_feature}{ScriptableRendererFeature}}}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{public}\ \textcolor{keyword}{override}\ \textcolor{keywordtype}{void}\ Create()}
\DoxyCodeLine{\ \ \ \ \{\ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{public}\ \textcolor{keyword}{override}\ \textcolor{keywordtype}{void}\ AddRenderPasses(\mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_renderer}{ScriptableRenderer}}\ renderer,}
\DoxyCodeLine{\ \ \ \ ref\ \mbox{\hyperlink{struct_unity_engine_1_1_rendering_1_1_universal_1_1_rendering_data}{RenderingData}}\ renderingData)}
\DoxyCodeLine{\ \ \ \ \{\ \}}
\DoxyCodeLine{\}}

\end{DoxyCode}


Add the Renderer Feature you created to the the Universal Renderer asset. \doxysectlink{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_dobad63f519f0fde26755d12ecfe7020ca}{Follow this link to read how to add a Renderer Feature to a Renderer}{0}.

~\newline
{\itshape Add the Lens Flare Renderer Feature to the Universal Renderer.}\hypertarget{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2400}{}\doxysection{\texorpdfstring{\label{_scriptable-render-pass}%
Create and enqueue the scriptable Render Pass}{\label{_scriptable-render-pass}%
Create and enqueue the scriptable Render Pass}}\label{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2400}
This part shows how to create a scriptable Render Pass and and enqueue its instance into the scriptable Renderer.


\begin{DoxyEnumerate}
\item In the {\ttfamily Lens\+Flare\+Renderer\+Feature} class, declare the {\ttfamily Lens\+Flare\+Pass} class that inherits from {\ttfamily Scriptable\+Render\+Pass}.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ \textcolor{keyword}{class\ }LensFlarePass\ :\ \mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_render_pass}{ScriptableRenderPass}}}
\DoxyCodeLine{\ \ \ \{\ \}}

\end{DoxyCode}

\item In {\ttfamily Lens\+Flare\+Pass}, add the {\ttfamily Execute} method.

\doxylink{namespace_unity}{Unity} runs the {\ttfamily Execute} method every frame. In this method, you can implement your custom rendering functionality.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ \textcolor{keyword}{public}\ \textcolor{keyword}{override}\ \textcolor{keywordtype}{void}\ Execute(ScriptableRenderContext\ context,}
\DoxyCodeLine{\ \ \ ref\ \mbox{\hyperlink{struct_unity_engine_1_1_rendering_1_1_universal_1_1_rendering_data}{RenderingData}}\ renderingData)}
\DoxyCodeLine{\ \ \ \{\ \}}

\end{DoxyCode}

\item In the {\ttfamily Lens\+Flare\+Renderer\+Feature} class, declare a private {\ttfamily Lens\+Flare\+Pass} field.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ \textcolor{keyword}{private}\ LensFlarePass\ \_lensFlarePass;}

\end{DoxyCode}

\item In the {\ttfamily Create} method, instantiate the {\ttfamily \+\_\+lens\+Flare\+Pass} object\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ \_lensFlarePass\ =\ \textcolor{keyword}{new}\ LensFlarePass(FlareSettings);}

\end{DoxyCode}

\item In the {\ttfamily Add\+Render\+Passes} method, use the {\ttfamily Enqueue\+Pass} method of the {\ttfamily renderer} object to enqueue {\ttfamily \+\_\+lens\+Flare\+Pass} in the rendering queue.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ renderer.EnqueuePass(\_lensFlarePass);}

\end{DoxyCode}

\end{DoxyEnumerate}

Now your custom {\ttfamily Lens\+Flare\+Renderer\+Feature} Renderer Feature is executing the {\ttfamily Execute} method inside the custom {\ttfamily Lens\+Flare\+Pass} pass.

Below is the complete code for this part.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\ \#}}
\DoxyCodeLine{\textcolor{keyword}{using\ }\mbox{\hyperlink{namespace_unity_engine}{UnityEngine}};}
\DoxyCodeLine{\textcolor{keyword}{using\ }UnityEngine.Rendering;}
\DoxyCodeLine{\textcolor{keyword}{using\ }UnityEngine.Rendering.Universal;}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{public}\ \textcolor{keyword}{class\ }LensFlareRendererFeature\ :\ \mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_renderer_feature}{ScriptableRendererFeature}}}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{class\ }LensFlarePass\ :\ \mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_render_pass}{ScriptableRenderPass}}}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keyword}{public}\ \textcolor{keyword}{override}\ \textcolor{keywordtype}{void}\ Execute(ScriptableRenderContext\ context,\ ref\ \mbox{\hyperlink{struct_unity_engine_1_1_rendering_1_1_universal_1_1_rendering_data}{RenderingData}}\ renderingData)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ Debug.Log(message:\ \textcolor{stringliteral}{"{}The\ Execute()\ method\ runs."{}});}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{private}\ LensFlarePass\ \_lensFlarePass;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{public}\ \textcolor{keyword}{override}\ \textcolor{keywordtype}{void}\ Create()}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \_lensFlarePass\ =\ \textcolor{keyword}{new}\ LensFlarePass();}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{public}\ \textcolor{keyword}{override}\ \textcolor{keywordtype}{void}\ AddRenderPasses(\mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_renderer}{ScriptableRenderer}}\ renderer,\ ref\ \mbox{\hyperlink{struct_unity_engine_1_1_rendering_1_1_universal_1_1_rendering_data}{RenderingData}}\ renderingData)}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ renderer.\mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_renderer_adef70d792e8e83c7feab314db83b02f2}{EnqueuePass}}(\_lensFlarePass);}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2401}{}\doxysection{\texorpdfstring{\label{_execute-method}%
Implement rendering commands in the Execute method}{\label{_execute-method}%
Implement rendering commands in the Execute method}}\label{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2401}
This part shows how to implement custom logic in the Execute method.


\begin{DoxyEnumerate}
\item Create a \href{https://docs.unity3d.com/2021.2/Documentation/ScriptReference/Rendering.CommandBuffer.html}{\texttt{ Command\+Buffer}} type object. This object holds the list of rendering commands to execute.

In the {\ttfamily Execute} method, add the following line\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ CommandBuffer\ cmd\ =\ CommandBufferPool.Get(name:\ \textcolor{stringliteral}{"{}LensFlarePass"{}});}

\end{DoxyCode}


The method {\ttfamily Command\+Buffer\+Pool.\+Get(name\+: "{}\+Lens\+Flare\+Pass"{})} gets the new command buffer and assigns a name to it.
\item Add the line that executes the command buffer and the line that releases it.

In the {\ttfamily Execute} method, add the following lines after the command buffer declaration\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ context.ExecuteCommandBuffer(cmd);}
\DoxyCodeLine{\ \ \ CommandBufferPool.Release(cmd);}

\end{DoxyCode}


Now the boilerplate part is ready and we can proceed to implementing the custom rendering logic.
\end{DoxyEnumerate}

The following steps implement the custom rendering logic.

In this example, the Renderer Feature draws lens flares as a texture on a Quad. The implementation requires a Material and a mesh (Quad).


\begin{DoxyEnumerate}
\item In the {\ttfamily Lens\+Flare\+Pass} class, declare two private fields\+: {\ttfamily Material} and {\ttfamily Mesh}\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ \textcolor{keyword}{private}\ \mbox{\hyperlink{namespace_unity_editor_1_1_rendering_1_1_universal_a7dc4ea5121011414a2a206509b9d5442ad92a8333dd3ccb895cc65f7455b71206}{Material}}\ \_material;}
\DoxyCodeLine{\ \ \ \textcolor{keyword}{private}\ Mesh\ \_mesh;}

\end{DoxyCode}


Then declare the constructor that takes those variables as arguments\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ \textcolor{keyword}{public}\ LensFlarePass(Material\ material,\ Mesh\ mesh)}
\DoxyCodeLine{\ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \_material\ =\ material;}
\DoxyCodeLine{\ \ \ \ \ \ \ \_mesh\ =\ mesh;}
\DoxyCodeLine{\ \ \ \}}

\end{DoxyCode}

\item Now the {\ttfamily Lens\+Flare\+Pass} class expects two arguments. To initialize the class with the arguments, add the following public fields in the {\ttfamily Lens\+Flare\+Renderer\+Feature} class\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ \textcolor{keyword}{public}\ \mbox{\hyperlink{namespace_unity_editor_1_1_rendering_1_1_universal_a7dc4ea5121011414a2a206509b9d5442ad92a8333dd3ccb895cc65f7455b71206}{Material}}\ material;}
\DoxyCodeLine{\ \ \ \textcolor{keyword}{public}\ Mesh\ mesh;}

\end{DoxyCode}


And add the arguments to the {\ttfamily Lens\+Flare\+Pass} declaration in the {\ttfamily Create} method\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ \_lensFlarePass\ =\ \textcolor{keyword}{new}\ LensFlarePass(material,\ mesh);}

\end{DoxyCode}

\item In the {\ttfamily Execute} method, use the {\ttfamily Draw\+Mesh} method of the {\ttfamily cmd} object. The method takes the {\ttfamily \+\_\+material} and the {\ttfamily \+\_\+mesh} fields as arguments. Add the following line between the {\ttfamily cmd} object declaration and the command {\ttfamily context.\+Execute\+Command\+Buffer(cmd)}.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ cmd.DrawMesh(\_mesh,\ Matrix4x4.identity,\ \_material);}

\end{DoxyCode}


To ensure that \doxylink{namespace_unity}{Unity} does call the {\ttfamily Draw\+Mesh} method with {\ttfamily null} arguments, in the {\ttfamily Add\+Render\+Passes} method, wrap the {\ttfamily Enqueue\+Pass} call in the null check condition\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ \textcolor{keywordflow}{if}\ (material\ !=\ null\ \&\&\ mesh\ !=\ null)}
\DoxyCodeLine{\ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ renderer.EnqueuePass(\_lensFlarePass);}
\DoxyCodeLine{\ \ \ \}}

\end{DoxyCode}

\end{DoxyEnumerate}

Now the {\ttfamily Lens\+Flare\+Pass} class has the following basic logic in the {\ttfamily Execute} method\+:


\begin{DoxyEnumerate}
\item Get the new command buffer and assign it the name {\ttfamily Lens\+Flare\+Pass}.
\item Add rendering commands.
\item Execute the command buffer.
\item Release the buffer.
\end{DoxyEnumerate}

\begin{quote}
{\bfseries{NOTE\+:}} \doxylink{namespace_unity}{Unity} does not enqueue the {\ttfamily Lens\+Flare\+Pass} pass yet, because the {\ttfamily Material} and the {\ttfamily Mesh} properties are null. \end{quote}


Below is the complete code for this part.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\ \#}}
\DoxyCodeLine{\textcolor{keyword}{using\ }\mbox{\hyperlink{namespace_unity_engine}{UnityEngine}};}
\DoxyCodeLine{\textcolor{keyword}{using\ }UnityEngine.Rendering;}
\DoxyCodeLine{\textcolor{keyword}{using\ }UnityEngine.Rendering.Universal;}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{public}\ \textcolor{keyword}{class\ }LensFlareRendererFeature\ :\ \mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_renderer_feature}{ScriptableRendererFeature}}}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{class\ }LensFlarePass\ :\ \mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_render_pass}{ScriptableRenderPass}}}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keyword}{private}\ \mbox{\hyperlink{namespace_unity_editor_1_1_rendering_1_1_universal_a7dc4ea5121011414a2a206509b9d5442ad92a8333dd3ccb895cc65f7455b71206}{Material}}\ \_material;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keyword}{private}\ Mesh\ \_mesh;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keyword}{public}\ LensFlarePass(Material\ material,\ Mesh\ mesh)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \_material\ =\ material;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \_mesh\ =\ mesh;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keyword}{public}\ \textcolor{keyword}{override}\ \textcolor{keywordtype}{void}\ Execute(ScriptableRenderContext\ context,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ ref\ \mbox{\hyperlink{struct_unity_engine_1_1_rendering_1_1_universal_1_1_rendering_data}{RenderingData}}\ renderingData)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ CommandBuffer\ cmd\ =\ CommandBufferPool.Get(name:\ \textcolor{stringliteral}{"{}LensFlarePass"{}});}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ cmd.DrawMesh(\_mesh,\ Matrix4x4.identity,\ \_material);}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ context.ExecuteCommandBuffer(cmd);}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ CommandBufferPool.Release(cmd);}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{private}\ LensFlarePass\ \_lensFlarePass;}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{public}\ \mbox{\hyperlink{namespace_unity_editor_1_1_rendering_1_1_universal_a7dc4ea5121011414a2a206509b9d5442ad92a8333dd3ccb895cc65f7455b71206}{Material}}\ material;}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{public}\ Mesh\ mesh;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{public}\ \textcolor{keyword}{override}\ \textcolor{keywordtype}{void}\ Create()}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \_lensFlarePass\ =\ \textcolor{keyword}{new}\ LensFlarePass(material,\ mesh);}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{public}\ \textcolor{keyword}{override}\ \textcolor{keywordtype}{void}\ AddRenderPasses(\mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_renderer}{ScriptableRenderer}}\ renderer,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ ref\ \mbox{\hyperlink{struct_unity_engine_1_1_rendering_1_1_universal_1_1_rendering_data}{RenderingData}}\ renderingData)}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (material\ !=\ null\ \&\&\ mesh\ !=\ null)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ renderer.\mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_renderer_adef70d792e8e83c7feab314db83b02f2}{EnqueuePass}}(\_lensFlarePass);}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2402}{}\doxysection{\texorpdfstring{\label{_example-specific-material}%
Implement the example-\/specific Material and rendering code}{\label{_example-specific-material}%
Implement the example-\/specific Material and rendering code}}\label{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2402}
This section shows how to create a Material for the lens flare effect and how to implement the code to render flares at the positions of Lights.


\begin{DoxyEnumerate}
\item Create a new Material, and assign it the {\ttfamily Universal Render Pipeline/\+Unlit} shader. Call the Material {\ttfamily Lens\+Flare}.
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item For demonstration purpose, change the base color of the Material to red.
\item In the Universal Renderer, in {\ttfamily Lens Flare Renderer Feature}, select the {\ttfamily Lens\+Flare} Material in the Material property, and the {\ttfamily Quad} mesh in the Mesh property.


\item The Renderer Feature draws the quad in the Scene, but at this point it\textquotesingle{}s just black. This is because the {\ttfamily Universal Render Pipeline/\+Unlit} shader has multiple passes, and one of them paints the quad black. To change this behavior, use the {\ttfamily cmd.\+Draw\+Mesh} method overload that accepts the {\ttfamily shader\+Pass} argument, and specify shader pass 0\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ cmd.DrawMesh(\_mesh,\ Matrix4x4.identity,\ \_material,\ 0,\ 0);}

\end{DoxyCode}

\end{DoxyEnumerate}

The following steps show the changes that are specific to the effect implementation in this example. They are for illustrative purposes.


\begin{DoxyEnumerate}
\item Add the following lines in the {\ttfamily Execute} method. Place them after the {\ttfamily cmd} object declaration. These lines ensure that \doxylink{namespace_unity}{Unity} draws the quad with the flare in the following way\+:


\begin{DoxyItemize}
\item In the screen space. 
\item With the correct aspect ratio. 
\item For each Light, in the center of the Light. 
\end{DoxyItemize}


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#}}
\DoxyCodeLine{\ \ \ \textcolor{comment}{//\ Get\ the\ Camera\ data\ from\ the\ renderingData\ argument.}}
\DoxyCodeLine{\ \ \ Camera\ camera\ =\ renderingData.cameraData.camera;}
\DoxyCodeLine{\ \ \ \textcolor{comment}{//\ Set\ the\ projection\ matrix\ so\ that\ Unity\ draws\ the\ quad\ in\ screen\ space}}
\DoxyCodeLine{\ \ \ cmd.SetViewProjectionMatrices(Matrix4x4.identity,\ Matrix4x4.identity);}
\DoxyCodeLine{\ \ \ \textcolor{comment}{//\ Add\ the\ scale\ variable,\ use\ the\ Camera\ aspect\ ratio\ for\ the\ y\ coordinate}}
\DoxyCodeLine{\ \ \ Vector3\ scale\ =\ \textcolor{keyword}{new}\ Vector3(1,\ camera.aspect,\ 1);}
\DoxyCodeLine{\ \ \ \textcolor{comment}{//\ Draw\ a\ quad\ for\ each\ Light,\ at\ the\ screen\ space\ position\ of\ the\ Light.}}
\DoxyCodeLine{\ \ \ \textcolor{keywordflow}{foreach}\ (VisibleLight\ visibleLight\ \textcolor{keywordflow}{in}\ renderingData.lightData.visibleLights)}
\DoxyCodeLine{\ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ Light\ light\ =\ visibleLight.light;}
\DoxyCodeLine{\ \ \ \ \ \ \ \textcolor{comment}{//\ Convert\ the\ position\ of\ each\ Light\ from\ world\ to\ viewport\ point.}}
\DoxyCodeLine{\ \ \ \ \ \ \ Vector3\ position\ =}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ camera.WorldToViewportPoint(light.transform.position)\ *\ 2\ -\/\ Vector3.one;}
\DoxyCodeLine{\ \ \ \ \ \ \ \textcolor{comment}{//\ Set\ the\ z\ coordinate\ of\ the\ quads\ to\ 0\ so\ that\ Uniy\ draws\ them\ on\ the\ same\ plane.}}
\DoxyCodeLine{\ \ \ \ \ \ \ position.z\ =\ 0;}
\DoxyCodeLine{\ \ \ \ \ \ \ \textcolor{comment}{//\ Change\ the\ Matrix4x4\ argument\ in\ the\ cmd.DrawMesh\ method\ to\ use\ the\ position\ and}}
\DoxyCodeLine{\ \ \ \ \ \ \ \textcolor{comment}{//\ the\ scale\ variables.}}
\DoxyCodeLine{\ \ \ \ \ \ \ cmd.DrawMesh(\_mesh,\ Matrix4x4.TRS(position,\ Quaternion.identity,\ scale),}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \_material,\ 0,\ 0);}
\DoxyCodeLine{\ \ \ \}}

\end{DoxyCode}


Now \doxylink{namespace_unity}{Unity} draws a quad in the center of each Light.


\item To visualize the lens flare, make the following changes to the {\ttfamily Lens\+Flare} Material.

Add the following texture to the base map\+:~\newline


Set the color to white.

Set {\ttfamily Surface Type} to {\ttfamily Transparent}.

Set {\ttfamily Blending Mode} to {\ttfamily Additive}.
\end{DoxyEnumerate}

Now \doxylink{namespace_unity}{Unity} draws the lens flare texture on the quad, but a part of the flare is not visible\+:



This is because \doxylink{namespace_unity}{Unity} draws the skybox after the {\ttfamily Lens\+Flare\+Pass} render pass.\hypertarget{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2403}{}\doxysection{\texorpdfstring{\label{_order-of-passes}%
Change the order of the render passes}{\label{_order-of-passes}%
Change the order of the render passes}}\label{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2403}
To see the order in which \doxylink{namespace_unity}{Unity} draws the render passes, open the {\bfseries{Frame Debugger}} ({\bfseries{Window}} \texorpdfstring{$>$}{>} {\bfseries{Analysis}} \texorpdfstring{$>$}{>} {\bfseries{Frame\&\#160;Debugger}}).



To enqueue the {\ttfamily Lens\+Flare\+Pass} pass after the skybox pass, use the {\ttfamily render\+Pass\+Event} property of {\ttfamily Lens\+Flare\+Pass}. Assign the property the {\ttfamily After\+Rendering\+Skybox} event from the {\ttfamily Render\+Pass\+Event} enum.

Make the following changes in the {\ttfamily Create} method\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\ \#}}
\DoxyCodeLine{\textcolor{keyword}{public}\ \textcolor{keyword}{override}\ \textcolor{keywordtype}{void}\ Create()}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \_lensFlarePass\ =\ \textcolor{keyword}{new}\ LensFlarePass(material,\ mesh);}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ Draw\ the\ lens\ flare\ effect\ after\ the\ skybox.}}
\DoxyCodeLine{\ \ \ \ \_lensFlarePass.renderPassEvent\ =\ \mbox{\hyperlink{namespace_unity_engine_1_1_rendering_1_1_universal_abcf86de95108d2ec392bc873e92392d5}{RenderPassEvent}}.AfterRenderingSkybox;}
\DoxyCodeLine{\}}

\end{DoxyCode}


Now \doxylink{namespace_unity}{Unity} draws the lens flare on top of the skybox.

\hypertarget{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2404}{}\doxysection{\texorpdfstring{\label{_complete-code}%
Complete code for this example}{\label{_complete-code}%
Complete code for this example}}\label{md__hey_tea_9_2_library_2_package_cache_2com_8unity_8render-pipelines_8universal_0d14_80_88_2_docb4b9d93723634e710064b46f0283951_autotoc_md2404}
Below is the complete code for this example.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\ \#}}
\DoxyCodeLine{\textcolor{keyword}{using\ }\mbox{\hyperlink{namespace_unity_engine}{UnityEngine}};}
\DoxyCodeLine{\textcolor{keyword}{using\ }UnityEngine.Rendering;}
\DoxyCodeLine{\textcolor{keyword}{using\ }UnityEngine.Rendering.Universal;}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{public}\ \textcolor{keyword}{class\ }LensFlareRendererFeature\ :\ \mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_renderer_feature}{ScriptableRendererFeature}}}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{class\ }LensFlarePass\ :\ \mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_render_pass}{ScriptableRenderPass}}}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keyword}{private}\ \mbox{\hyperlink{namespace_unity_editor_1_1_rendering_1_1_universal_a7dc4ea5121011414a2a206509b9d5442ad92a8333dd3ccb895cc65f7455b71206}{Material}}\ \_material;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keyword}{private}\ Mesh\ \_mesh;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keyword}{public}\ LensFlarePass(Material\ material,\ Mesh\ mesh)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \_material\ =\ material;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \_mesh\ =\ mesh;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keyword}{public}\ \textcolor{keyword}{override}\ \textcolor{keywordtype}{void}\ Execute(ScriptableRenderContext\ context,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ ref\ \mbox{\hyperlink{struct_unity_engine_1_1_rendering_1_1_universal_1_1_rendering_data}{RenderingData}}\ renderingData)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ CommandBuffer\ cmd\ =\ CommandBufferPool.Get(name:\ \textcolor{stringliteral}{"{}LensFlarePass"{}});}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ the\ Camera\ data\ from\ the\ renderingData\ argument.}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ Camera\ camera\ =\ renderingData.cameraData.camera;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Set\ the\ projection\ matrix\ so\ that\ Unity\ draws\ the\ quad\ in\ screen\ space.}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ cmd.SetViewProjectionMatrices(Matrix4x4.identity,\ Matrix4x4.identity);}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ the\ scale\ variable,\ use\ the\ Camera\ aspect\ ratio\ for\ the\ y\ coordinate}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ Vector3\ scale\ =\ \textcolor{keyword}{new}\ Vector3(1,\ camera.aspect,\ 1);}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Draw\ a\ quad\ for\ each\ Light,\ at\ the\ screen\ space\ position\ of\ the\ Light.}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{foreach}\ (VisibleLight\ visibleLight\ \textcolor{keywordflow}{in}\ renderingData.lightData.visibleLights)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Light\ light\ =\ visibleLight.light;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Convert\ the\ position\ of\ each\ Light\ from\ world\ to\ viewport\ point.}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Vector3\ position\ =}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ camera.WorldToViewportPoint(light.transform.position)\ *\ 2\ -\/\ Vector3.one;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Set\ the\ z\ coordinate\ of\ the\ quads\ to\ 0\ so\ that\ Uniy\ draws\ them\ on\ the\ same}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ plane.}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ position.z\ =\ 0;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Change\ the\ Matrix4x4\ argument\ in\ the\ cmd.DrawMesh\ method\ to\ use}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ position\ and\ the\ scale\ variables.}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cmd.DrawMesh(\_mesh,\ Matrix4x4.TRS(position,\ Quaternion.identity,\ scale),}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_material,\ 0,\ 0);}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ context.ExecuteCommandBuffer(cmd);}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ CommandBufferPool.Release(cmd);}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{private}\ LensFlarePass\ \_lensFlarePass;}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{public}\ \mbox{\hyperlink{namespace_unity_editor_1_1_rendering_1_1_universal_a7dc4ea5121011414a2a206509b9d5442ad92a8333dd3ccb895cc65f7455b71206}{Material}}\ material;}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{public}\ Mesh\ mesh;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{public}\ \textcolor{keyword}{override}\ \textcolor{keywordtype}{void}\ Create()}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \_lensFlarePass\ =\ \textcolor{keyword}{new}\ LensFlarePass(material,\ mesh);}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{comment}{//\ Draw\ the\ lens\ flare\ effect\ after\ the\ skybox.}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \_lensFlarePass.renderPassEvent\ =\ \mbox{\hyperlink{namespace_unity_engine_1_1_rendering_1_1_universal_abcf86de95108d2ec392bc873e92392d5}{RenderPassEvent}}.AfterRenderingSkybox;}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{public}\ \textcolor{keyword}{override}\ \textcolor{keywordtype}{void}\ AddRenderPasses(\mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_renderer}{ScriptableRenderer}}\ renderer,\ ref\ \mbox{\hyperlink{struct_unity_engine_1_1_rendering_1_1_universal_1_1_rendering_data}{RenderingData}}\ renderingData)}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (material\ !=\ null\ \&\&\ mesh\ !=\ null)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ renderer.\mbox{\hyperlink{class_unity_engine_1_1_rendering_1_1_universal_1_1_scriptable_renderer_adef70d792e8e83c7feab314db83b02f2}{EnqueuePass}}(\_lensFlarePass);}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{\}}

\end{DoxyCode}
 